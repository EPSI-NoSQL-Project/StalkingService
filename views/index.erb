<!doctype html>
<html lang="fr">
<head>
	<meta charset="utf-8">
	<title>Stalker</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<link rel="stylesheet" href="http://getbootstrap.com/examples/sticky-footer/sticky-footer.css">
	<link rel="stylesheet" href="http://getbootstrap.com/examples/sticky-footer/sticky-footer.css">
	<link href="http://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
	<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
	<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
	<script src="https://github.com/mgalante/jquery.redirect/blob/master/jquery.redirect.js"></script>
	<script>
		function url_redirect(options)
		{
			var $form = $("<form />");

			$form.attr("action",options.url);
			$form.attr("method",options.method);
			for (var data in options.data)
			{
				$form.append('<input type="hidden" name="'+data+'" value="'+options.data[data]+'" />');
			}
			
			$("body").append($form);

			$form.submit();
		}

		$(function() {
			$( "#nameToFind" ).autocomplete({
				minLength: 2,
				source: function(request, response) 
				{
					var suggestions = [];
					var uriElasticsearch = "http://localhost:9200/people/person/_search";
					uriElasticsearch += "?q=name:*"+request.term+"*";
					uriElasticsearch += "&fields=_id,name,location";
					
					$.ajax({
						url: uriElasticsearch,
						dataType: 'jsonp',
						success:function(data)
						{
							var result = $.map(data, function(jsonpData) { return jsonpData; });
							var persons = result[3].hits;
							persons.forEach(function(entry) {
								suggestions.push({
									"id": entry._id, 
									"value": entry.fields.name + "(" + entry.fields.location + ")"
								});
							});
							response(suggestions);
						},
						error:function(jqXHR,textStatus,errorThrown)
						{
							alert("You can not send Cross Domain AJAX requests: "+errorThrown);
						}
					});
				},
				select : function(event, ui){
					// alert( ui.item.id );
					url_redirect({url: "/people",
						method: "post",
						data: {
							"id": ui.item.id, 
							"nameToFind": ui.item.value
						}
					});
				}
			});
		});
	</script>
</head>
<body>
	<div class="container">
	<div class="page-header">
	<h1>Qui souhaitez-vous stalker ?</h1>
	</div>
		<form id="people" action="/people" method="post" class="form-horizontal">
			 <div class="form-group">
				<label for="nameToFind" class="col-sm-2 control-label">Name :</label>
				<div class="col-sm-10">
				<input type="text" class="form-control ui-widget" id="nameToFind" name="nameToFind" 
					required placeholder="Toto"
					value="<%= nameToFind %>">
				</div>
			</div>

			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<button type="submit" class="btn btn-default">Chercher</button>
				</div>
			</div>
		</form>
	</div>
</body>
<footer class="footer">
	<div class="text-center">
		<p class="text-muted">
			Mailys AIROUCHE & Vincent KELLEHER & Amandine PALLAS & Kim SAVAROCHE & Theo VERMERSCH
		</p>
	</div>
</footer>
</html>